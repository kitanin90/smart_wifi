# smart_wifi

#Загрузка проекта на сервер
1. Загрузить проект на ПК через терминал можно с помощью команды:
```sh
$ git clone https://github.com/kitanin90/smart_wifi.git
```

# Настройка проекта
После успешной загрузки необходимо провести ряд настроек:
* Скопировать `.env.example` в `.env` и отредактировать файл(Либо просто переименовать файл)
* Изменить настройки в `settings.py`
* Запустить `docker-compose up -d`
* Создать суперпользователя `docker-compose exec web python3 manage.py createsuperuser`
* Создать миграцию `docker-compose exec web python3 manage.py makemigrations`
* Выполнить миграцию `docker-compose exec web python3 manage.py migrate`


#Настройка роутеров на примере tp-link archer c7
1. Скачать прошивку Openwrt "http://downloads.openwrt.org/releases/18.06.4/targets/ar71xx/generic/openwrt-18.06.4-ar71xx-generic-archer-c7-v4-squashfs-factory.bin"
2. Подключиться к роутеру через сетевой кабель в любой LAN-порт
3. В админ панель роутера в разделе "fireware upgrade" загрузить скачанный файл прошивки "OpenWrt"

![Alt text](img/img1.jpg?raw=true "Title")
4. Перейти по 192.168.1.1 (или 192.168.0.1) в админку openwrt. Поставить на роутер пароль.
5. В разделе "Interfeces" удалить интерфейс WAN6
6. Настроить интерфейс WAN:

-Ipv4 address - ip адрес роутера

-Ipv4 gateway - ip адрес сервера
![Alt text](img/img2.jpg?raw=true "Title")

7. Настроить firewall для WAN input включить accept

![Alt text](img/firewall.png?raw=true "Title")


**Подключиться к роутеру через WAN**

8. Подключаемся к роутеру по ssh (ssh root@192.168.3.*)и вводим команды для установки необходимого:
 - opkg update
 - opkg install python3-light libustream-openssl ca-bundle ca-certificates
 - wget https://strbsu.tk/configure_router.py
 
9. Далее скачиваем скрипт настройки роутера "wget https://raw.githubusercontent.com/kitanin90/smart_wifi/master/tools/configure_router.py"
10. python3 configure_router.py 
11. Отвечаем на два вопроса:
 - Номер роутера по счету(порядковый)
 - Ввести любое число
12. Перезагрузить freeradfius. Перейти в папку проекта и ввести в терминале "docker-compose restart freeradius"


# Настройка административной панели Django
В случае успешного выполнения пунктов, описанных выше Вы сможете зайти в админ.панель Django в браузере перейдя по `localhost/admin`

##    Добавление Корпусов и Факультетов
* Прежде всего добавьте корпуса в соответствующем разделе.
Заполните пункты: `Название` и `адрес`

* Аналогично добавьте факультеты

##  Создание клиентов:
***Ручное добавление:***
* Добавить новых клиентов можно в разделе `Клиенты`
* Заполнить соответствующие поля: ФИО, Username, Статус, Телефон, Факультет
* `Username` клиента состоит из его фамилии и инициалов (например, IvanovAA)

Чтобы задать пароль для клиента, перейдите и добавьте в `Параметры клиента`:
1. Заполните соответствующий `Username` клиента
2. В `Attribute` введите `Cleartext-Password`
3. `Op` будет содержать `:=`
4. В `Value` введите пароль для клиента

***Автоматическое добавление:***

Если у вас большая база клиентов, вы можете добавить их с помощью файла в формате `.csv`. Для этого перейдите в браузере на `http://localhost/panel/upload_file`.
В данном случае, скрипт создаст и настроит параметры клиента вместо вас.

**Внимание!** 
Скрипт начинает считывать клиентов с 7 строки в вашей базе данных! Каждый параметр разделяется с помощью `;` в соответствующей колонки(Пример формата для заполнения БД: `;;ИвановАА;;;;Пароль;`)


# Настройка точек доступа
Для системы нужно знать с какими роутерами ей нужно работать.
Подключитесь к роутеру через сетевой кабель по ssh и введите пароль от админ.панели роутера(например, ssh root@10.42.0.46). С помощью команды `ifconfig`
Для этого необходимо каждый роутер добавить в разделе `Роутеры`:
Некоторые данные можно узнать с помощью `ifconfig`, либо на обратной стороне роутера.
 * `Название`  - название роутрера
 * `ip`  - Ip-адрес узнайте в `ifconfig` 
 * `Порт`  - Обычно "0"
 * `Токен`  - Токен узнайте `ifconfig` (например, serkettoken)
 * `MAC`  - MAC узнайте в `ifconfig` (например, 1C-2S-3X-4Z-5T-6J)
 * `Корпус`  - Выберите корпус, в котором стоит роутер

**ВНИМАНИЕ!** После изменений в админ.панели Django перезагрузите freeradius командой `docker-compose restart freeradius`

